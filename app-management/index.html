<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>应用管理原型</title>
    <!-- Using Bootstrap 5 for layout and styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .header {
            height: 60px;
            background-color: #004a96; /* BASF Blue-ish */
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            flex-shrink: 0;
        }
        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 240px;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
            padding-top: 20px;
            flex-shrink: 0;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #fff;
        }
        .nav-link.active {
            background-color: #e9ecef;
            font-weight: bold;
            color: #004a96;
        }
        .status-badge {
            min-width: 100px;
        }
        /* Wizard Styles */
        .wizard-step {
            display: none;
        }
        .wizard-step.active {
            display: block;
        }
        .template-list-item {
            cursor: pointer;
        }
        .template-list-item.active {
            background-color: #004a96;
            color: white;
            border-color: #004a96;
        }

        /* Terraform Code Viewer */
        .tf-code-pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            white-space: pre;
            overflow: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            height: 100%;
            min-height: 0;
        }
        .tf-code-editor {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            height: 100%;
            min-height: 0;
        }

        /* TF step container: keep within modal and scroll inside panels */
        .tf-pane {
            height: 55vh;
            max-height: 420px;
            min-height: 260px;
        }
    </style>
</head>
<body>

    <!-- 1. Header -->
    <header class="header">
        <h4 class="m-0">BASF App Management</h4>
    </header>

    <div class="app-container">
        <!-- 2. Left Sidebar -->
        <nav class="sidebar">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#">
                        <i class="bi bi-grid-fill me-2"></i>应用管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-secondary" href="#">
                        其他AAA
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-secondary" href="#">
                        其他BBB
                    </a>
                </li>
            </ul>
        </nav>

        <!-- 3. Right Operation Area -->
        <main class="main-content">
            <!-- Tabs -->
            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="#">应用列表</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">审批历史</a>
                </li>
            </ul>

            <!-- Toolbar -->
            <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light border rounded">
                <div class="d-flex align-items-center">
                    <label class="me-2 fw-bold">工作区:</label>
                    <select class="form-select form-select-sm" style="width: 200px;">
                        <option value="all">全部工作区</option>
                        <option value="ws1">Workspace Alpha</option>
                        <option value="ws2">Workspace Beta</option>
                    </select>
                </div>
                <div>
                    <!-- Added id and removed data-bs-toggle/target to handle via JS -->
                    <button class="btn btn-primary btn-sm" id="btnOpenCreate">
                        <span class="me-1">+</span>申请应用创建
                    </button>
                </div>
            </div>

            <!-- Data Table -->
            <div class="table-responsive">
                <table class="table table-hover table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Resource Group Name</th>
                            <th>Name</th>
                            <th>Resources Count</th>
                            <th>Status</th>
                            <th style="width: 200px;">Operation</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Row 1: Created Status -->
                        <tr>
                            <td>BASF_RG_AllowPE_Dev_Marketing</td>
                            <td>Marketing Portal</td>
                            <td>5</td>
                            <td><span class="badge bg-secondary status-badge">Created</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1 edit-app-btn">编辑</button>
                                <button class="btn btn-sm btn-outline-danger">删除</button>
                                <button class="btn btn-sm btn-light text-secondary">Azure Portal</button>
                            </td>
                        </tr>
                        
                        <!-- Row 2: Approve Pending Status -->
                        <tr>
                            <td>BASF_RG_AllowPE_Dev_HRAnalytics</td>
                            <td>HR Analytics DB</td>
                            <td>2</td>
                            <td><span class="badge bg-warning text-dark status-badge">Approve Pending</span></td>
                            <td>
                                <button class="btn btn-sm btn-success">批准</button>
                            </td>
                        </tr>

                        <!-- Row 3: Provisioning Status -->
                        <tr>
                            <td>BASF_RG_AllowPE_Dev_Logistics</td>
                            <td>Logistics API</td>
                            <td>8</td>
                            <td><span class="badge bg-info text-dark status-badge">Provisioning</span></td>
                            <td>
                                <button class="btn btn-sm btn-light text-secondary">Azure Portal</button>
                            </td>
                        </tr>

                         <!-- Row 4: Created Status (Another example) -->
                         <tr>
                            <td>BASF_RG_AllowPE_Dev_InternalWiki</td>
                            <td>Internal Wiki</td>
                            <td>1</td>
                            <td><span class="badge bg-secondary status-badge">Approve Rejected</span></td>
                            <td>
                                <button class="btn btn-sm btn-light text-secondary">批准情况</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Create App Wizard Modal -->
    <div class="modal fade" id="createAppModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">创建新应用</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Step 1: Basic Info -->
                    <div id="step1" class="wizard-step active">
                        <h6 class="mb-3 border-bottom pb-2">Step 1: 基本信息</h6>
                        <div class="mb-3">
                            <label class="form-label">Workspace</label>
                            <select class="form-select" id="appWorkspace">
                                <option value="" selected disabled>Select a workspace...</option>
                                <option value="ws1">Workspace Alpha</option>
                                <option value="ws2">Workspace Beta</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Resource Group Name</label>
                            <input type="text" class="form-control" id="appCode" placeholder="e.g. BASF_RG_AllowPE_Dev_Share">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" id="appName" placeholder="Application Name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="appDesc" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Step 2: Template Selection -->
                    <div id="step2" class="wizard-step">
                        <h6 class="mb-3 border-bottom pb-2">Step 2: 模板与组件</h6>
                        <div class="row" style="height: 300px;">
                            <!-- Left: Template List -->
                            <div class="col-4 border-end overflow-auto h-100" id="templateCol">
                                <label class="form-label fw-bold">选择应用模板</label>
                                <div class="list-group" id="templateList">
                                    <a href="#" class="list-group-item list-group-item-action template-list-item active" data-template="custom">Custom</a>
                                    <a href="#" class="list-group-item list-group-item-action template-list-item" data-template="vm-linux_mssql-db">vm-linux_mssql-db</a>
                                    <a href="#" class="list-group-item list-group-item-action template-list-item" data-template="container-app_mssql-db">container-app_mssql-db</a>
                                    <a href="#" class="list-group-item list-group-item-action template-list-item" data-template="static-web-app">static-web-app</a>
                                </div>
                            </div>
                            <!-- Right: Component List -->
                            <div class="col-8 overflow-auto h-100" id="componentCol">
                                <label class="form-label fw-bold">使用组件 (Azure Resources)</label>
                                
                                <!-- Custom Controls (Hidden unless Custom is selected) -->
                                <div id="customControls" class="mb-3 p-2 bg-light border rounded">
                                    <div class="input-group input-group-sm">
                                        <select class="form-select" id="componentSelect">
                                            <option value="Virtual Machine">Virtual Machine</option>
                                            <option value="SQL Database">SQL Database</option>
                                            <option value="Storage Account">Storage Account</option>
                                            <option value="App Service">App Service</option>
                                            <option value="Key Vault">Key Vault</option>
                                        </select>
                                        <button class="btn btn-outline-primary" type="button" id="addComponentBtn">Add Component</button>
                                    </div>
                                </div>

                                <ul class="list-group" id="componentList">
                                    <!-- Components will be injected here -->
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Parameters -->
                    <div id="step3" class="wizard-step">
                        <h6 class="mb-3 border-bottom pb-2">Step 3: 参数设置</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Name (Read-only)</th>
                                        <th>Type (Terraform)</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody id="paramTableBody">
                                    <!-- Params injected via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Step 4: Terraform Code -->
                    <div id="step4" class="wizard-step">
                        <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
                            <h6 class="m-0">Step 4: Terraform 代码</h6>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="tfEditBtn" style="display: none;">编辑</button>
                                <button type="button" class="btn btn-sm btn-primary" id="tfSaveBtn" style="display: none;">保存</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="tfCancelBtn" style="display: none;">取消</button>
                            </div>
                        </div>

                        <div class="row g-3 tf-pane">
                            <div class="col-4 h-100">
                                <div class="list-group h-100 overflow-auto" id="tfFileList"></div>
                            </div>
                            <div class="col-8 h-100 d-flex flex-column">
                                <pre id="tfCodeContent" class="tf-code-pre"></pre>
                                <textarea id="tfCodeEditor" class="form-control tf-code-editor" style="display:none;"></textarea>
                                <div class="form-text mt-2" id="tfHintText">
                                    说明：选择模板创建时，Terraform 代码为只读；选择自定义组件时可进入编辑模式。
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5: Summary -->
                    <div id="step5" class="wizard-step">
                        <h6 class="mb-3 border-bottom pb-2">Step 5: 汇总确认</h6>
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <dl class="row mb-0">
                                    <dt class="col-sm-3">Code</dt>
                                    <dd class="col-sm-9" id="summaryCode">-</dd>

                                    <dt class="col-sm-3">Name</dt>
                                    <dd class="col-sm-9" id="summaryName">-</dd>

                                    <dt class="col-sm-3">Workspace</dt>
                                    <dd class="col-sm-9" id="summaryWorkspace">-</dd>

                                    <dt class="col-sm-3">Template</dt>
                                    <dd class="col-sm-9" id="summaryTemplate">-</dd>

                                    <dt class="col-sm-3">Components</dt>
                                    <dd class="col-sm-9" id="summaryComponents">-</dd>

                                    <dt class="col-sm-3">Cost</dt>
                                    <dd class="col-sm-9" id="summaryCost">-</dd>
                                </dl>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>请确认以上信息无误，提交后将开始审批流程。
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary" id="prevBtn" disabled>上一步</button>
                    <div>
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="nextBtn">下一步</button>
                        <button type="button" class="btn btn-success" id="submitBtn" style="display: none;">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Wizard Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentStep = 1;
            const totalSteps = 5;
            let wizardMode = 'create'; // 'create' or 'edit'
            const modalEl = document.getElementById('createAppModal');
            const modal = new bootstrap.Modal(modalEl);
            
            // Data Models
            const templates = {
                'custom': [], // Dynamic
                'vm-linux_mssql-db': ['Virtual Machine (Linux)', 'SQL Database (MSSQL)', 'Virtual Network'],
                'container-app_mssql-db': ['Container App Environment', 'Container App', 'SQL Database (MSSQL)'],
                'static-web-app': ['Static Web App']
            };
            
            let wizardData = {
                code: '',
                name: '',
                desc: '',
                workspace: '',
                template: 'custom',
                components: [], // Current list of components
                params: [],
                tfFiles: [],
                tfSelectedFileIndex: 0,
                tfDirty: false,
                tfEditing: false
            };

            // DOM Elements
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            const templateItems = document.querySelectorAll('.template-list-item');
            const customControls = document.getElementById('customControls');
            const componentList = document.getElementById('componentList');
            const addComponentBtn = document.getElementById('addComponentBtn');
            const componentSelect = document.getElementById('componentSelect');

            // Step 4 (Terraform) Elements
            const tfFileListEl = document.getElementById('tfFileList');
            const tfCodeContentEl = document.getElementById('tfCodeContent');
            const tfCodeEditorEl = document.getElementById('tfCodeEditor');
            const tfEditBtn = document.getElementById('tfEditBtn');
            const tfSaveBtn = document.getElementById('tfSaveBtn');
            const tfCancelBtn = document.getElementById('tfCancelBtn');

            // Layout Elements
            const templateCol = document.getElementById('templateCol');
            const componentCol = document.getElementById('componentCol');
            const appWorkspace = document.getElementById('appWorkspace');
            const appCode = document.getElementById('appCode');
            const appName = document.getElementById('appName');
            const appDesc = document.getElementById('appDesc');

            // --- Mode Handling ---
            document.getElementById('btnOpenCreate').addEventListener('click', () => {
                initWizard('create');
                modal.show();
            });

            document.querySelectorAll('.edit-app-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    initWizard('edit');
                    modal.show();
                });
            });

            function initWizard(mode) {
                wizardMode = mode;
                currentStep = 1;
                showStep(1);
                
                // Reset Data
                wizardData = {
                    code: '',
                    name: '',
                    desc: '',
                    workspace: '',
                    template: 'custom',
                    components: [],
                    params: [],
                    tfFiles: [],
                    tfSelectedFileIndex: 0,
                    tfDirty: false,
                    tfEditing: false
                };

                if (mode === 'create') {
                    document.querySelector('.modal-title').textContent = '创建新应用';
                    
                    // Step 1 UI
                    appWorkspace.disabled = false;
                    appCode.disabled = false;
                    appWorkspace.value = "";
                    appCode.value = "";
                    appName.value = "";
                    appDesc.value = "";

                    // Step 2 UI
                    templateCol.style.display = 'block';
                    componentCol.className = 'col-8 overflow-auto h-100';
                    customControls.style.display = 'none'; // Hidden initially
                    
                    // Reset template selection
                    templateItems.forEach(t => t.classList.remove('active'));
                    templateItems[0].classList.add('active'); 
                    wizardData.template = 'custom';
                    customControls.style.display = 'block'; 

                } else {
                    document.querySelector('.modal-title').textContent = '编辑应用';

                    // Step 1 UI - Mock Data
                    appWorkspace.value = "ws1";
                    appCode.value = "BASF_RG_AllowPE_Dev_Marketing";
                    appName.value = "Marketing Portal";
                    appDesc.value = "Existing marketing portal application.";
                    
                    appWorkspace.disabled = true;
                    appCode.disabled = true;

                    // Step 2 UI
                    templateCol.style.display = 'none';
                    componentCol.className = 'col-12 overflow-auto h-100';
                    customControls.style.display = 'block'; // Always allow editing components

                    // Mock Components
                    wizardData.template = 'custom';
                    wizardData.components = ['Virtual Machine (Linux)', 'SQL Database (MSSQL)', 'Storage Account', 'Key Vault', 'App Service'];
                }
                renderComponents();
                resetTerraformState();
            }

            // --- Navigation Logic ---
            function showStep(step) {
                document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
                document.getElementById('step' + step).classList.add('active');
                
                // Button State
                prevBtn.disabled = step === 1;
                if (step === totalSteps) {
                    nextBtn.style.display = 'none';
                    submitBtn.style.display = 'inline-block';
                    renderSummary();
                } else {
                    nextBtn.style.display = 'inline-block';
                    submitBtn.style.display = 'none';
                    nextBtn.innerText = '下一步';
                }

                if (step === 4) {
                    // Ensure TF view is up-to-date when user arrives
                    syncWizardDataFromInputs();
                    ensureTerraformFiles();
                    renderTerraformView();
                }
            }

            nextBtn.addEventListener('click', () => {
                if (currentStep < totalSteps) {
                    // Validation logic could go here
                    if (currentStep === 2) {
                        // Prepare Step 3 data before moving
                        prepareParams();
                    }
                    if (currentStep === 3) {
                        // Prepare Step 4 data before moving
                        syncWizardDataFromInputs();
                        ensureTerraformFiles();
                    }
                    currentStep++;
                    showStep(currentStep);
                }
            });

            prevBtn.addEventListener('click', () => {
                if (currentStep > 1) {
                    currentStep--;
                    showStep(currentStep);
                }
            });

            // --- Step 2: Template Logic ---
            function renderComponents() {
                componentList.innerHTML = '';
                wizardData.components.forEach(comp => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.textContent = comp;
                    
                    // Allow removing if custom OR edit mode
                    if (wizardData.template === 'custom' || wizardMode === 'edit') {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-sm btn-outline-danger border-0';
                        btn.innerHTML = '&times;';
                        btn.onclick = () => {
                            wizardData.components = wizardData.components.filter(c => c !== comp);
                            renderComponents();
                        };
                        li.appendChild(btn);
                    }
                    componentList.appendChild(li);
                });
            }

            templateItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    if (wizardMode === 'edit') return;
                    e.preventDefault();
                    // UI Update
                    templateItems.forEach(t => t.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Data Update
                    const selectedTemp = item.getAttribute('data-template');
                    wizardData.template = selectedTemp;

                    // Logic
                    if (selectedTemp === 'custom') {
                        customControls.style.display = 'block';
                        wizardData.components = []; // Reset or keep? Resetting for simplicity
                    } else {
                        customControls.style.display = 'none';
                        wizardData.components = [...templates[selectedTemp]];
                    }
                    renderComponents();
                    resetTerraformState();
                });
            });

            addComponentBtn.addEventListener('click', () => {
                const val = componentSelect.value;
                if (val) {
                    wizardData.components.push(val);
                    renderComponents();
                    resetTerraformState();
                }
            });

            // --- Step 4: Terraform Code Logic ---
            function resetTerraformState() {
                wizardData.tfFiles = [];
                wizardData.tfSelectedFileIndex = 0;
                wizardData.tfDirty = false;
                wizardData.tfEditing = false;
                if (tfCodeEditorEl) tfCodeEditorEl.value = '';
            }

            function syncWizardDataFromInputs() {
                wizardData.workspace = appWorkspace.value || '';
                wizardData.code = appCode.value || '';
                wizardData.name = appName.value || '';
                wizardData.desc = appDesc.value || '';
            }

            function isTerraformEditable() {
                // Requirement:
                // - If Step2 selected a template (non-custom): TF code not editable
                // - If Step2 selected components (custom): TF code editable
                // In edit mode, we also allow editing.
                if (wizardMode === 'edit') return true;
                return wizardData.template === 'custom';
            }

            function ensureTerraformFiles() {
                // If user hasn't manually edited/saved TF, keep it in sync with current wizard inputs.
                if (wizardData.tfFiles && wizardData.tfFiles.length > 0 && wizardData.tfDirty) return;

                const prevSelected = wizardData.tfSelectedFileIndex || 0;
                wizardData.tfFiles = generateTerraformFiles();
                wizardData.tfSelectedFileIndex = Math.min(prevSelected, wizardData.tfFiles.length - 1);
                wizardData.tfEditing = false;
            }

            function generateTerraformFiles() {
                const code = (wizardData.code || 'BASF_RG_AllowPE_Dev_Example').trim();
                const name = (wizardData.name || 'Example App').trim();
                const location = 'eastasia';
                const environment = 'dev';

                const isTemplateMode = wizardData.template !== 'custom' && wizardMode !== 'edit';
                const selectedTemplate = wizardData.template;

                if (isTemplateMode) {
                    const mainTf = `terraform {\n  required_version = \">= 1.6.0\"\n}\n\n# Generated from template: ${selectedTemplate}\n# App: ${name}\n\nmodule \"app\" {\n  source = \"./templates/${selectedTemplate}\"\n\n  resource_group_name = var.resource_group_name\n  location            = var.location\n  environment         = var.environment\n}\n`;

                    const variablesTf = `variable \"resource_group_name\" {\n  type = string\n  default = \"${code}\"\n}\n\nvariable \"location\" {\n  type = string\n  default = \"${location}\"\n}\n\nvariable \"environment\" {\n  type = string\n  default = \"${environment}\"\n}\n`;

                    return [
                        { name: 'main.tf', code: mainTf },
                        { name: 'variables.tf', code: variablesTf }
                    ];
                }

                // Custom/components mode
                const resourceSnippets = {
                    'Virtual Machine': `# Virtual Machine\nresource \"azurerm_linux_virtual_machine\" \"vm\" {\n  name                = \"${name.toLowerCase().replace(/\s+/g, '-')}-vm\"\n  resource_group_name = var.resource_group_name\n  location            = var.location\n  size                = var.vm_size\n\n  admin_username      = var.vm_admin_username\n  admin_password      = var.vm_admin_password\n\n  disable_password_authentication = false\n}\n`,
                    'SQL Database': `# SQL Database\nresource \"azurerm_mssql_database\" \"db\" {\n  name      = \"${name.toLowerCase().replace(/\s+/g, '-')}-db\"\n  server_id = azurerm_mssql_server.sql.id\n  sku_name  = var.sql_sku\n}\n`,
                    'Storage Account': `# Storage Account\nresource \"azurerm_storage_account\" \"stg\" {\n  name                     = replace(lower(\"${name}\"), \"-\", \"\")\n  resource_group_name      = var.resource_group_name\n  location                 = var.location\n  account_tier             = \"Standard\"\n  account_replication_type = \"LRS\"\n}\n`,
                    'App Service': `# App Service\nresource \"azurerm_service_plan\" \"plan\" {\n  name                = \"${name.toLowerCase().replace(/\s+/g, '-')}-plan\"\n  resource_group_name = var.resource_group_name\n  location            = var.location\n  os_type             = \"Linux\"\n  sku_name            = var.app_sku\n}\n`,
                    'Key Vault': `# Key Vault\nresource \"azurerm_key_vault\" \"kv\" {\n  name                = \"${name.toLowerCase().replace(/\s+/g, '-')}-kv\"\n  resource_group_name = var.resource_group_name\n  location            = var.location\n  tenant_id           = data.azurerm_client_config.current.tenant_id\n  sku_name            = var.kv_sku\n}\n\ndata \"azurerm_client_config\" \"current\" {}\n`
                };

                const lines = [];
                lines.push(`terraform {\n  required_version = \">= 1.6.0\"\n}\n`);
                lines.push(`# Generated from custom components`);
                lines.push(`# App: ${name}`);
                lines.push('');

                wizardData.components.forEach(comp => {
                    const key = Object.keys(resourceSnippets).find(k => comp.includes(k));
                    if (key) lines.push(resourceSnippets[key]);
                    else lines.push(`# ${comp}\n# TODO: add terraform resources for this component\n`);
                });

                if (wizardData.components.length === 0) {
                    lines.push('# No components selected.');
                }

                const mainTf = lines.join('\n');

                const variablesTf = `variable \"resource_group_name\" {\n  type = string\n  default = \"${code}\"\n}\n\nvariable \"location\" {\n  type = string\n  default = \"${location}\"\n}\n\nvariable \"environment\" {\n  type = string\n  default = \"${environment}\"\n}\n\n# VM\nvariable \"vm_size\" {\n  type    = string\n  default = \"Standard_D2s_v3\"\n}\nvariable \"vm_admin_username\" {\n  type    = string\n  default = \"azureuser\"\n}\nvariable \"vm_admin_password\" {\n  type      = string\n  sensitive = true\n  default   = \"\"\n}\n\n# SQL\nvariable \"sql_sku\" {\n  type    = string\n  default = \"S0\"\n}\n\n# App Service\nvariable \"app_sku\" {\n  type    = string\n  default = \"P1v2\"\n}\n\n# Key Vault\nvariable \"kv_sku\" {\n  type    = string\n  default = \"standard\"\n}\n`;

                return [
                    { name: 'main.tf', code: mainTf },
                    { name: 'variables.tf', code: variablesTf }
                ];
            }

            function renderTerraformView() {
                // Build file list
                tfFileListEl.innerHTML = '';
                const files = wizardData.tfFiles || [];
                files.forEach((f, idx) => {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.className = 'list-group-item list-group-item-action' + (idx === wizardData.tfSelectedFileIndex ? ' active' : '');
                    a.textContent = f.name;
                    a.dataset.idx = String(idx);
                    tfFileListEl.appendChild(a);
                });

                const selected = files[wizardData.tfSelectedFileIndex];
                const code = selected ? selected.code : '暂无代码';

                const editable = isTerraformEditable();
                const isEditing = wizardData.tfEditing;

                // Buttons
                tfEditBtn.style.display = editable && !isEditing ? 'inline-block' : 'none';
                tfSaveBtn.style.display = editable && isEditing ? 'inline-block' : 'none';
                tfCancelBtn.style.display = editable && isEditing ? 'inline-block' : 'none';

                // Viewer/editor
                if (editable && isEditing) {
                    tfCodeContentEl.style.display = 'none';
                    tfCodeEditorEl.style.display = 'block';
                    tfCodeEditorEl.value = code;
                } else {
                    tfCodeEditorEl.style.display = 'none';
                    tfCodeContentEl.style.display = 'block';
                    tfCodeContentEl.textContent = code;
                }
            }

            tfFileListEl.addEventListener('click', (e) => {
                const a = e.target.closest('a');
                if (!a) return;
                e.preventDefault();

                // If editing, switching file discards unsaved changes (simple prototype behavior)
                if (wizardData.tfEditing) {
                    if (!confirm('当前文件未保存，切换将丢失修改，继续吗？')) return;
                    wizardData.tfEditing = false;
                }

                wizardData.tfSelectedFileIndex = Number(a.dataset.idx);
                renderTerraformView();
            });

            tfEditBtn.addEventListener('click', () => {
                if (!isTerraformEditable()) return;
                wizardData.tfEditing = true;
                renderTerraformView();
            });

            tfCancelBtn.addEventListener('click', () => {
                wizardData.tfEditing = false;
                renderTerraformView();
            });

            tfSaveBtn.addEventListener('click', () => {
                if (!isTerraformEditable()) return;
                const files = wizardData.tfFiles || [];
                if (!files[wizardData.tfSelectedFileIndex]) return;
                files[wizardData.tfSelectedFileIndex].code = tfCodeEditorEl.value;
                wizardData.tfDirty = true;
                wizardData.tfEditing = false;
                renderTerraformView();
            });

            // --- Step 3: Parameters Logic ---
            function prepareParams() {
                const tbody = document.getElementById('paramTableBody');
                tbody.innerHTML = '';
                
                // 1. Define Definitions (Mock Data)
                const globalParams = [
                    { name: 'environment', type: 'string', value: 'dev' },
                    { name: 'location', type: 'string', value: 'eastasia' }
                ];

                const paramDefinitions = {
                    'Virtual Machine': [
                        { name: 'vm_size', type: 'string', value: 'Standard_D2s_v3' },
                        { name: 'vm_admin_username', type: 'string', value: 'azureuser' },
                        { name: 'vm_admin_password', type: 'securestring', value: '' }
                    ],
                    'SQL Database': [
                        { name: 'sql_sku', type: 'string', value: 'S0' },
                        { name: 'sql_admin_username', type: 'string', value: 'sqladmin' },
                        { name: 'sql_admin_password', type: 'securestring', value: '' }
                    ],
                    'Container App': [
                        { name: 'cpu', type: 'number', value: '0.5' },
                        { name: 'memory', type: 'string', value: '1.0Gi' },
                        { name: 'image_tag', type: 'string', value: 'latest' }
                    ],
                    'Storage Account': [
                        { name: 'stg_sku', type: 'string', value: 'Standard_LRS' }
                    ],
                    'App Service': [
                        { name: 'app_sku', type: 'string', value: 'P1v2' }
                    ],
                    'Key Vault': [
                        { name: 'kv_sku', type: 'string', value: 'standard' }
                    ]
                };

                // 2. Collect all params with source
                let allParams = [];
                // Add globals
                globalParams.forEach(p => allParams.push({ ...p, source: 'Common' }));

                // Add component params
                wizardData.components.forEach(compName => {
                    // Find matching definition key
                    const key = Object.keys(paramDefinitions).find(k => compName.includes(k));
                    if (key) {
                        paramDefinitions[key].forEach(p => {
                            allParams.push({ ...p, source: compName });
                        });
                    }
                });

                // 3. Identify duplicates (to merge into Common)
                let nameCounts = {};
                allParams.forEach(p => {
                    if (p.source !== 'Common') {
                        nameCounts[p.name] = (nameCounts[p.name] || 0) + 1;
                    }
                });

                // 4. Grouping
                let groups = { 'Common': [] };
                // Initialize component groups to preserve order
                wizardData.components.forEach(c => { groups[c] = []; });

                let addedToCommon = new Set();

                // Process Globals first
                allParams.filter(p => p.source === 'Common').forEach(p => {
                    groups['Common'].push(p);
                    addedToCommon.add(p.name);
                });

                // Process Component Params
                allParams.filter(p => p.source !== 'Common').forEach(p => {
                    if (nameCounts[p.name] > 1) {
                        // Move to Common if duplicate across components
                        if (!addedToCommon.has(p.name)) {
                            groups['Common'].push({ ...p });
                            addedToCommon.add(p.name);
                        }
                    } else {
                        // Keep in component group
                        if (!groups[p.source]) groups[p.source] = [];
                        groups[p.source].push(p);
                    }
                });

                // 5. Render
                Object.keys(groups).forEach(groupName => {
                    const groupParams = groups[groupName];
                    if (groupParams.length === 0) return;

                    // Group Header
                    const trHeader = document.createElement('tr');
                    trHeader.className = 'table-secondary';
                    trHeader.innerHTML = `<td colspan="3" class="fw-bold">${groupName}</td>`;
                    tbody.appendChild(trHeader);

                    // Params
                    groupParams.forEach(p => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${p.name}</td>
                            <td><span class="badge bg-light text-dark border">${p.type}</span></td>
                            <td><input type="${p.type === 'securestring' ? 'password' : 'text'}" class="form-control form-control-sm" value="${p.value}"></td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
            }

            // --- Step 4: Summary Logic ---
            function renderSummary() {
                document.getElementById('summaryCode').textContent = document.getElementById('appCode').value || '-';
                document.getElementById('summaryName').textContent = document.getElementById('appName').value || '-';
                
                const wsSelect = document.getElementById('appWorkspace');
                document.getElementById('summaryWorkspace').textContent = wsSelect.options[wsSelect.selectedIndex].text;
                
                document.getElementById('summaryTemplate').textContent = wizardMode === 'edit' ? 'Custom (Edit)' : wizardData.template;
                document.getElementById('summaryComponents').textContent = wizardData.components.join(', ') || 'None';

                const costEl = document.getElementById('summaryCost');
                if (wizardMode === 'edit') {
                    costEl.innerHTML = `
                        <span class="text-decoration-line-through text-secondary me-2">￥1500/月</span>
                        <span class="fw-bold text-primary">￥1850/月</span>
                        <span class="badge bg-danger ms-2">+￥350</span>
                    `;
                } else {
                    costEl.textContent = '￥1500/月'; // Placeholder cost
                }
            }

            // Initialize
            // renderComponents(); // Moved to initWizard
        });
    </script>
</body>
</html>
